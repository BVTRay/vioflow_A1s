# 小程序开发环境设置指南

## 前置要求

1. 已注册微信小程序账号
2. 已获取小程序 AppID
3. 已安装微信开发者工具
4. 后端 API 已部署并可访问

## 设置步骤

### 1. 安装微信开发者工具

1. 访问 [微信开发者工具下载页面](https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html)
2. 下载并安装对应操作系统的版本
3. 使用微信扫码登录

### 2. 导入项目

1. 打开微信开发者工具
2. 选择"导入项目"或"+" -> "导入项目"
3. 选择项目目录：`/www/wwwroot/vioflow-A/vioflow_A1s-1/miniprogram`
4. 填写项目信息：
   - **项目名称**：Vioflow 小程序
   - **AppID**：`wx88534d2b615d32a5`
   - **开发模式**：小程序
5. 点击"导入"

### 3. 配置 API 地址

编辑 `utils/config.js` 文件：

```javascript
module.exports = {
  // 修改为实际的后端 API 地址
  apiBaseUrl: 'https://your-api-domain.com/api',
  appId: 'wx88534d2b615d32a5',
};
```

**注意**：
- 本地开发：可以使用 `http://localhost:3002/api`（需要开启"不校验合法域名"）
- 生产环境：必须使用 HTTPS 域名

### 4. 配置服务器域名

在微信公众平台配置服务器域名：

1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入小程序管理后台
3. 开发 -> 开发管理 -> 开发设置 -> 服务器域名
4. 点击"修改"，添加以下域名：

**request 合法域名**：
```
https://your-api-domain.com
```

**uploadFile 合法域名**（如果需要上传文件）：
```
https://your-api-domain.com
```

**downloadFile 合法域名**（如果需要下载文件）：
```
https://your-api-domain.com
```

5. 保存配置

### 5. 开发环境设置

#### 方式一：不校验合法域名（仅开发环境）

1. 在微信开发者工具中
2. 点击右上角"详情"
3. 勾选"不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"
4. 这样就可以使用 `http://localhost` 进行本地开发

#### 方式二：使用内网穿透（推荐）

1. 使用 ngrok、frp 等工具将本地后端暴露为公网地址
2. 在 `utils/config.js` 中配置内网穿透地址
3. 在微信公众平台配置该域名

### 6. 测试登录功能

1. 在微信开发者工具中点击"编译"
2. 在模拟器中测试：
   - 手机号登录流程
   - 微信登录流程
3. 使用真机预览测试实际效果

## 开发调试

### 查看日志

1. 在微信开发者工具中打开"调试器"
2. 查看 Console 标签页的日志
3. 查看 Network 标签页的网络请求

### 常见问题排查

#### 问题1：网络请求失败

**检查项**：
- ✅ API 地址是否正确
- ✅ 服务器域名是否已配置
- ✅ 后端服务是否正常运行
- ✅ 是否开启了"不校验合法域名"（开发环境）

#### 问题2：登录失败

**检查项**：
- ✅ 后端是否正确配置了微信 AppID 和 AppSecret
- ✅ 后端短信服务是否配置正确
- ✅ 查看后端日志确认错误信息

#### 问题3：Token 无效

**检查项**：
- ✅ Token 是否正确保存
- ✅ Token 是否过期
- ✅ 后端 JWT 配置是否正确

## 真机预览

1. 在微信开发者工具中点击"预览"
2. 使用微信扫码
3. 在手机上测试功能

## 发布流程

### 1. 上传代码

1. 在微信开发者工具中点击"上传"
2. 填写版本号和项目备注
3. 点击"上传"

### 2. 提交审核

1. 登录微信公众平台
2. 版本管理 -> 开发版本 -> 选择版本 -> 提交审核
3. 填写审核信息
4. 提交审核

### 3. 发布

审核通过后：
1. 版本管理 -> 审核版本 -> 选择版本 -> 发布
2. 确认发布

## 相关链接

- [微信小程序开发文档](https://developers.weixin.qq.com/miniprogram/dev/framework/)
- [微信公众平台](https://mp.weixin.qq.com/)
- [后端 API 文档](../backend/src/modules/auth/README.md)






