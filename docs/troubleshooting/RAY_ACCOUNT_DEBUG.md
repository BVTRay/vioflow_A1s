# Ray 账号数据加载问题排查

## 🔍 问题诊断

从测试结果看：
- ✅ ray 用户存在且状态正常
- ✅ ray 在不恭文化团队中（super_admin 角色）
- ✅ 不恭文化团队有 13 个项目
- ✅ API 测试成功，返回了 1 个团队和 13 个项目

但前端看不到数据，可能的原因：

## 🐛 可能的问题

### 1. 团队加载时序问题
- `TeamContext` 中 `setCurrentTeam` 是异步的
- `useApiData` 可能在团队设置完成前就执行了
- 导致 `currentTeam` 为 `null`，数据不加载

### 2. 依赖数组问题
- `loadTeams` 的依赖可能不完整
- 导致团队加载后 `currentTeam` 没有及时更新

### 3. 状态更新问题
- React 状态更新是异步的
- `setCurrentTeam` 后立即检查 `currentTeam` 可能还是旧值

## ✅ 已修复

### 1. 优化团队选择逻辑
- 使用 `currentTeamRef` 来跟踪当前团队
- 在选择团队时立即更新 ref，确保后续逻辑能获取到最新值

### 2. 添加详细日志
- 在关键步骤添加日志输出
- 方便排查问题

### 3. 优化数据加载触发
- 在 `useApiData` 中添加更详细的日志
- 确保在团队加载完成后才加载数据

## 🚀 测试步骤

1. **清除浏览器缓存**
   - 清除 localStorage
   - 清除浏览器缓存

2. **重新登录**
   - 使用 ray@bugong.com / admin 登录

3. **查看浏览器控制台**
   - 应该能看到以下日志：
     ```
     🔄 开始加载团队列表...
     ✅ 加载到团队: 1 个 ['不恭文化']
     ✅ 设置当前团队: 不恭文化 [团队ID]
     🔄 useApiData: 检测到团队变化，开始加载数据
     🔄 开始加载数据，当前团队: [团队ID] 不恭文化
     📡 请求项目列表: ...
     📥 收到项目列表: 13 个项目
     ✅ 数据加载完成: { projects: 13, videos: 12, ... }
     ```

4. **如果仍然看不到数据**
   - 检查控制台是否有错误
   - 检查网络请求是否成功
   - 检查响应数据是否正确

## 📝 技术细节

### 修复的关键点

1. **使用 useRef 跟踪当前团队**
   ```typescript
   const currentTeamRef = useRef<Team | null>(null);
   // 在选择团队时立即更新
   currentTeamRef.current = selectedTeam;
   ```

2. **优化团队选择逻辑**
   - 按优先级选择：已有团队 > 用户默认 > localStorage > 第一个团队
   - 确保总是能选择一个团队

3. **添加详细日志**
   - 每个步骤都有日志输出
   - 方便排查问题

## ⚠️ 如果问题仍然存在

请提供浏览器控制台的完整日志，包括：
1. 团队加载日志
2. 数据加载日志
3. 任何错误信息
4. 网络请求的响应

这样我可以更准确地定位问题。

