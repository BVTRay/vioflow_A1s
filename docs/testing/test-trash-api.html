<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>å›æ”¶ç«™APIæµ‹è¯•</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #fff; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #4CAF50; }
        .section { background: #2a2a2a; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .info { color: #2196F3; }
        pre { background: #1a1a1a; padding: 10px; border-radius: 3px; overflow-x: auto; }
        button { background: #4CAF50; color: white; border: none; padding: 10px 20px; 
                 border-radius: 3px; cursor: pointer; margin: 5px; }
        button:hover { background: #45a049; }
        input { background: #1a1a1a; color: #fff; border: 1px solid #444; 
                padding: 8px; border-radius: 3px; width: 400px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ—‘ï¸ å›æ”¶ç«™APIæµ‹è¯•å·¥å…·</h1>
        
        <div class="section">
            <h3>1. ç™»å½•è·å–Token</h3>
            <input type="email" id="email" placeholder="é‚®ç®±" value="ray@vioflow.com">
            <input type="password" id="password" placeholder="å¯†ç " value="ray">
            <button onclick="login()">ç™»å½•</button>
            <div id="loginResult"></div>
        </div>

        <div class="section">
            <h3>2. è·å–å›¢é˜Ÿä¿¡æ¯</h3>
            <button onclick="getTeams()">è·å–å›¢é˜Ÿåˆ—è¡¨</button>
            <div id="teamsResult"></div>
        </div>

        <div class="section">
            <h3>3. è·å–å›æ”¶ç«™è§†é¢‘</h3>
            <input type="text" id="teamId" placeholder="å›¢é˜ŸID" value="15b4a45f-a0a6-4577-a01f-b37152cfbcf8">
            <button onclick="getDeletedVideos()">è·å–å·²åˆ é™¤è§†é¢‘</button>
            <div id="videosResult"></div>
        </div>

        <div class="section">
            <h3>4. è°ƒè¯•ä¿¡æ¯</h3>
            <div id="debugInfo"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3002';
        let token = localStorage.getItem('test_token') || '';
        let currentTeamId = '15b4a45f-a0a6-4577-a01f-b37152cfbcf8';

        function log(elementId, message, type = 'info') {
            const el = document.getElementById(elementId);
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            el.innerHTML += `<div class="${className}">${message}</div>`;
        }

        function clearLog(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        async function login() {
            clearLog('loginResult');
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                log('loginResult', 'ğŸ” æ­£åœ¨ç™»å½•...', 'info');
                const response = await fetch(`${API_BASE}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: email, password })
                });

                if (!response.ok) {
                    throw new Error(`ç™»å½•å¤±è´¥: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                token = data.access_token || data.accessToken;
                localStorage.setItem('test_token', token);
                
                log('loginResult', 'âœ… ç™»å½•æˆåŠŸ!', 'success');
                log('loginResult', `Token: ${token.substring(0, 50)}...`, 'info');
                log('loginResult', `ç”¨æˆ·: ${data.user?.name || data.user?.email}`, 'info');
                
                log('debugInfo', `âœ… Tokenå·²ä¿å­˜: ${token.substring(0, 30)}...`, 'success');
            } catch (error) {
                log('loginResult', `âŒ é”™è¯¯: ${error.message}`, 'error');
                console.error('Login error:', error);
            }
        }

        async function getTeams() {
            clearLog('teamsResult');
            if (!token) {
                log('teamsResult', 'âŒ è¯·å…ˆç™»å½•è·å–Token', 'error');
                return;
            }

            try {
                log('teamsResult', 'ğŸ“¡ æ­£åœ¨è·å–å›¢é˜Ÿåˆ—è¡¨...', 'info');
                const response = await fetch(`${API_BASE}/api/teams`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`è¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
                }

                const teams = await response.json();
                log('teamsResult', `âœ… æ‰¾åˆ° ${teams.length} ä¸ªå›¢é˜Ÿ:`, 'success');
                teams.forEach(team => {
                    log('teamsResult', `<pre>ID: ${team.id}\nåç§°: ${team.name}</pre>`, 'info');
                    currentTeamId = team.id; // ä½¿ç”¨ç¬¬ä¸€ä¸ªå›¢é˜ŸID
                });
                
                document.getElementById('teamId').value = currentTeamId;
            } catch (error) {
                log('teamsResult', `âŒ é”™è¯¯: ${error.message}`, 'error');
                console.error('Get teams error:', error);
            }
        }

        async function getDeletedVideos() {
            clearLog('videosResult');
            if (!token) {
                log('videosResult', 'âŒ è¯·å…ˆç™»å½•è·å–Token', 'error');
                return;
            }

            const teamId = document.getElementById('teamId').value;
            if (!teamId) {
                log('videosResult', 'âŒ è¯·è¾“å…¥å›¢é˜ŸID', 'error');
                return;
            }

            try {
                log('videosResult', `ğŸ“¡ æ­£åœ¨è·å–å›¢é˜Ÿ ${teamId} çš„å›æ”¶ç«™è§†é¢‘...`, 'info');
                log('debugInfo', `ğŸ“¡ è¯·æ±‚URL: ${API_BASE}/api/videos/trash/list?teamId=${teamId}`, 'info');
                log('debugInfo', `ğŸ“¡ è¯·æ±‚å¤´: x-team-id: ${teamId}`, 'info');
                
                const response = await fetch(`${API_BASE}/api/videos/trash/list?teamId=${teamId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'x-team-id': teamId,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`è¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}\n${errorText}`);
                }

                const videos = await response.json();
                log('videosResult', `âœ… æ‰¾åˆ° ${videos.length} ä¸ªå·²åˆ é™¤çš„è§†é¢‘:`, 'success');
                
                if (videos.length === 0) {
                    log('videosResult', 'ğŸ“­ å›æ”¶ç«™ä¸ºç©º', 'info');
                } else {
                    videos.forEach((video, index) => {
                        const deletedAt = new Date(video.deleted_at);
                        const now = new Date();
                        const daysAgo = Math.floor((now - deletedAt) / (1000 * 60 * 60 * 24));
                        
                        log('videosResult', `<pre>${index + 1}. ${video.name}
   ID: ${video.id}
   é¡¹ç›®ID: ${video.project_id || 'æœªçŸ¥'}
   åˆ é™¤æ—¶é—´: ${deletedAt.toLocaleString('zh-CN')} (${daysAgo}å¤©å‰)
   æ–‡ä»¶å¤§å°: ${(video.size / 1024 / 1024).toFixed(2)} MB</pre>`, 'info');
                    });
                    
                    log('debugInfo', `âœ… æˆåŠŸè·å–${videos.length}ä¸ªå·²åˆ é™¤è§†é¢‘`, 'success');
                    log('debugInfo', `<pre>${JSON.stringify(videos[0], null, 2)}</pre>`, 'info');
                }
            } catch (error) {
                log('videosResult', `âŒ é”™è¯¯: ${error.message}`, 'error');
                log('debugInfo', `âŒ è·å–å›æ”¶ç«™å¤±è´¥: ${error.message}`, 'error');
                console.error('Get deleted videos error:', error);
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºtokençŠ¶æ€
        window.onload = function() {
            if (token) {
                log('debugInfo', `âœ… å·²ä¿å­˜Token: ${token.substring(0, 30)}...`, 'success');
                log('debugInfo', 'ğŸ’¡ å¯ä»¥ç›´æ¥æµ‹è¯•è·å–å›¢é˜Ÿå’Œå›æ”¶ç«™', 'info');
            } else {
                log('debugInfo', 'âš ï¸ æœªç™»å½•,è¯·å…ˆç™»å½•è·å–Token', 'info');
            }
        };
    </script>
</body>
</html>
