# åç«¯ç›®å½•æ•´ç†æ€»ç»“

## ğŸ“… æ•´ç†æ—¥æœŸ
2026-01-05

## ğŸ¯ æ•´ç†ç›®æ ‡
è§£å†³"æ ¹ç›®å½•æ±¡æŸ“"é—®é¢˜ï¼Œå°†é¡¹ç›®é…ç½®ã€ä¸€æ¬¡æ€§è¿ç§»è„šæœ¬ã€è¿ç»´è„šæœ¬ã€ä¸šåŠ¡æºç åˆ†ç±»æ•´ç†ï¼Œä½¿ NestJS é¡¹ç›®ç»“æ„æ›´æ¸…æ™°ã€æ›´è§„èŒƒã€‚

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. åˆ é™¤çš„åƒåœ¾æ–‡ä»¶
- âœ… `.env.backup.20260104_180429` - é…ç½®å¤‡ä»½æ–‡ä»¶ï¼ˆå·²åˆ é™¤ï¼‰
- âœ… `.env.supabase.backup.20260104_195733` - Supabaseé…ç½®å¤‡ä»½ï¼ˆå·²åˆ é™¤ï¼‰
- âœ… `migration.log` - è¿ç§»æ—¥å¿—æ–‡ä»¶ï¼ˆå·²åˆ é™¤ï¼‰

**ç†ç”±**: å¸¦æ—¶é—´æˆ³çš„é…ç½®å¤‡ä»½ä¸åº”è¯¥æ”¾åœ¨ä»£ç åº“ä¸­ï¼Œå®¹æ˜“é€ æˆæ··æ·†å’Œå®‰å…¨éšæ‚£ã€‚

### 2. æ›´æ–°çš„ .gitignore
æ–°å¢ä»¥ä¸‹è§„åˆ™ç¡®ä¿æ•æ„Ÿæ•°æ®ä¸ä¼šè¢«æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶ï¼š
```gitignore
# å¤‡ä»½æ–‡ä»¶
*.backup*

# æ•°æ®åº“å¯¼å‡ºï¼ˆåŒ…å«æ•æ„Ÿæ•°æ®ï¼‰
database_export_*
*.sql.gz
*.dump

# æ—¥å¿—æ–‡ä»¶
*.log
logs/
```

**é‡è¦æç¤º**: `database_export_2026-01-04/` ç›®å½•åŒ…å«å®Œæ•´æ•°æ®åº“å¯¼å‡ºï¼Œç°å·²è¢« `.gitignore` ä¿æŠ¤ï¼Œå»ºè®®å®šæœŸå¤‡ä»½åˆ°å®‰å…¨ä½ç½®å¹¶ä»é¡¹ç›®ç›®å½•ä¸­ç§»é™¤ã€‚

### 3. åˆ›å»ºçš„æ–°ç›®å½•ç»“æ„

```
backend/scripts/
â”œâ”€â”€ migrations/       # ä¸€æ¬¡æ€§æ•°æ®è¿ç§»è„šæœ¬
â”œâ”€â”€ maintenance/      # æ—¥å¸¸ç»´æŠ¤å’Œæ£€æŸ¥å·¥å…·
â””â”€â”€ ci/              # CI/CDå’Œå¯åŠ¨ç›¸å…³è„šæœ¬
```

### 4. å½’ç±»æ•´ç†çš„è„šæœ¬æ–‡ä»¶

#### scripts/migrations/ (æ•°æ®è¿ç§»è„šæœ¬ - 7ä¸ªæ–‡ä»¶)
- `migrate-r2-to-local.ts` - R2äº‘å­˜å‚¨è¿ç§»åˆ°æœ¬åœ°
- `migrate-videos-to-local.ts` - è§†é¢‘æ–‡ä»¶è¿ç§»åˆ°æœ¬åœ°
- `import-to-local.sh` - æ•°æ®å¯¼å…¥åˆ°æœ¬åœ°
- `export-from-supabase.sh` - ä»Supabaseå¯¼å‡ºæ•°æ®
- `switch-to-local-db.sh` - åˆ‡æ¢åˆ°æœ¬åœ°æ•°æ®åº“
- `quick-migrate.sh` - å¿«é€Ÿè¿ç§»è„šæœ¬
- `add_annotation_fields.js` - æ·»åŠ æ³¨é‡Šå­—æ®µ

#### scripts/maintenance/ (ç»´æŠ¤å·¥å…· - 7ä¸ªæ–‡ä»¶)
- `check-deleted-videos.ts` - æ£€æŸ¥å·²åˆ é™¤çš„è§†é¢‘
- `check-r2-thumbnails.ts` - æ£€æŸ¥R2ç¼©ç•¥å›¾
- `check-thumbnail-progress.ts` - æ£€æŸ¥ç¼©ç•¥å›¾ç”Ÿæˆè¿›åº¦
- `check-video-urls.ts` - æ£€æŸ¥è§†é¢‘URL
- `check_annotation.js` - æ£€æŸ¥æ³¨é‡Šæ•°æ®
- `regenerate-thumbnails.ts` - â­ é‡æ–°ç”Ÿæˆç¼©ç•¥å›¾ï¼ˆé‡è¦è¿ç»´å·¥å…·ï¼‰
- `init-storage-structure.sh` - åˆå§‹åŒ–å­˜å‚¨ç›®å½•ç»“æ„

#### scripts/ci/ (CI/CDè„šæœ¬ - 3ä¸ªæ–‡ä»¶)
- `start.sh` - å¯åŠ¨è„šæœ¬
- `check-api.sh` - APIå¥åº·æ£€æŸ¥
- `test-api.sh` - APIæµ‹è¯•

### 5. é‡å‘½åçš„æ–‡ä»¶
- âœ… `env.local-storage.example` â†’ `.env.example`

**ç†ç”±**: ä½¿ç”¨æ ‡å‡†çš„ `.env.example` å‘½åçº¦å®šï¼Œç¬¦åˆNode.jsé¡¹ç›®æœ€ä½³å®è·µã€‚

## ğŸ“Š æ•´ç†å‰åå¯¹æ¯”

### æ•´ç†å‰ï¼ˆæ ¹ç›®å½•æ–‡ä»¶ï¼‰
```
backend/
â”œâ”€â”€ é…ç½®æ–‡ä»¶ (3ä¸ª)
â”œâ”€â”€ æ ¸å¿ƒé…ç½® (4ä¸ª): nest-cli.json, package.json, tsconfig.json, README.md
â”œâ”€â”€ è¿ç§»è„šæœ¬ (7ä¸ª): migrate-*.ts, *-to-local.sh, quick-migrate.sh...
â”œâ”€â”€ ç»´æŠ¤è„šæœ¬ (7ä¸ª): check-*.ts, regenerate-thumbnails.ts...
â”œâ”€â”€ CIè„šæœ¬ (3ä¸ª): start.sh, check-api.sh, test-api.sh
â”œâ”€â”€ å¤‡ä»½æ–‡ä»¶ (2ä¸ª): .env.backup.*, .env.supabase.backup.*
â”œâ”€â”€ æ—¥å¿—æ–‡ä»¶ (1ä¸ª): migration.log
â””â”€â”€ æºç /æ„å»ºç›®å½•: src/, dist/, node_modules/, uploads/
```
**é—®é¢˜**: æ ¹ç›®å½•æ··ä¹±ï¼ŒåŒ…å«20+ä¸ªæ‚é¡¹æ–‡ä»¶

### æ•´ç†åï¼ˆæ ¹ç›®å½•æ–‡ä»¶ï¼‰
```
backend/
â”œâ”€â”€ .env                  # ç¯å¢ƒå˜é‡ï¼ˆ.gitignoreï¼‰
â”œâ”€â”€ .env.example          # ç¯å¢ƒå˜é‡ç¤ºä¾‹
â”œâ”€â”€ .gitignore           # Gitå¿½ç•¥è§„åˆ™ï¼ˆå·²æ›´æ–°ï¼‰
â”œâ”€â”€ nest-cli.json        # NestJSé…ç½®
â”œâ”€â”€ package.json         # é¡¹ç›®ä¾èµ–
â”œâ”€â”€ package-lock.json    # ä¾èµ–é”å®š
â”œâ”€â”€ tsconfig.json        # TypeScripté…ç½®
â”œâ”€â”€ README.md            # é¡¹ç›®è¯´æ˜
â”œâ”€â”€ dist/                # æ„å»ºäº§ç‰©ï¼ˆ.gitignoreï¼‰
â”œâ”€â”€ node_modules/        # ä¾èµ–ï¼ˆ.gitignoreï¼‰
â”œâ”€â”€ uploads/             # ç”¨æˆ·ä¸Šä¼ ï¼ˆ.gitignoreï¼‰
â”œâ”€â”€ logs/                # æ—¥å¿—ï¼ˆ.gitignoreï¼‰
â”œâ”€â”€ src/                 # ã€æ ¸å¿ƒä»£ç ã€‘
â””â”€â”€ scripts/             # ã€æ‰€æœ‰è„šæœ¬ã€‘
    â”œâ”€â”€ migrations/      # ä¸€æ¬¡æ€§æ•°æ®è¿ç§»ï¼ˆ7ä¸ªï¼‰
    â”œâ”€â”€ maintenance/     # ç»´æŠ¤å·¥å…·ï¼ˆ7ä¸ªï¼‰
    â””â”€â”€ ci/             # CI/CDè„šæœ¬ï¼ˆ3ä¸ªï¼‰
```
**æ”¹è¿›**: æ ¹ç›®å½•æ¸…çˆ½ï¼Œåªä¿ç•™æ ¸å¿ƒé…ç½®æ–‡ä»¶å’Œç›®å½•

## ğŸš€ ä½¿ç”¨æŒ‡å—

### è¿è¡Œè¿ç§»è„šæœ¬
```bash
# TypeScript è„šæœ¬
npx ts-node scripts/migrations/migrate-r2-to-local.ts

# Shell è„šæœ¬
sh scripts/migrations/quick-migrate.sh
```

### è¿è¡Œç»´æŠ¤å·¥å…·
```bash
# é‡æ–°ç”Ÿæˆç¼©ç•¥å›¾
npx ts-node scripts/maintenance/regenerate-thumbnails.ts

# æ£€æŸ¥è§†é¢‘URL
npx ts-node scripts/maintenance/check-video-urls.ts
```

### å¯åŠ¨æœåŠ¡
```bash
# ä½¿ç”¨å¯åŠ¨è„šæœ¬
sh scripts/ci/start.sh

# æˆ–ä½¿ç”¨ npm scriptsï¼ˆæ¨èï¼‰
npm run start:dev
npm run start:prod
```

### æµ‹è¯•API
```bash
sh scripts/ci/test-api.sh
```

## ğŸ“ åç»­å»ºè®®

### 1. æ›´æ–° package.json scripts
å»ºè®®åœ¨ `package.json` ä¸­æ·»åŠ å¸¸ç”¨è„šæœ¬çš„å¿«æ·å‘½ä»¤ï¼š

```json
{
  "scripts": {
    "start:custom": "sh scripts/ci/start.sh",
    "test:api": "sh scripts/ci/test-api.sh",
    "maintenance:thumbnails": "ts-node scripts/maintenance/regenerate-thumbnails.ts",
    "migration:r2-to-local": "ts-node scripts/migrations/migrate-r2-to-local.ts"
  }
}
```

### 2. æ•°æ®åº“å¯¼å‡ºå¤„ç†
`database_export_2026-01-04/` ç›®å½•åŒ…å«æ•æ„Ÿæ•°æ®ï¼š
- âœ… å·²åœ¨ `.gitignore` ä¸­å±è”½
- âš ï¸ å»ºè®®å¤‡ä»½åˆ°å®‰å…¨ä½ç½®åä»é¡¹ç›®ç›®å½•åˆ é™¤
- æ¨èä½¿ç”¨ä¸“ä¸šå¤‡ä»½å·¥å…·å®šæœŸå¤‡ä»½

### 3. è„šæœ¬é‡æ„å»ºè®®
éƒ¨åˆ†ç‹¬ç«‹ TypeScript è„šæœ¬å¯èƒ½éœ€è¦è®¿é—® NestJS çš„ Serviceï¼š
- è€ƒè™‘å°†å…¶é‡æ„ä¸º NestJS Standalone Applications
- æˆ–ä½¿ç”¨ `nestjs-command` åº“åˆ›å»ºæ§åˆ¶å°å‘½ä»¤
- æš‚æ—¶å¯ä»¥ç»§ç»­ä½¿ç”¨ `ts-node` è¿è¡Œ

### 4. æ–‡æ¡£ç»´æŠ¤
- å»ºè®®åœ¨ `scripts/` ç›®å½•ä¸‹æ·»åŠ  `README.md` è¯´æ˜å„è„šæœ¬ç”¨é€”
- æ ‡è®°å“ªäº›æ˜¯ä¸€æ¬¡æ€§è¿ç§»è„šæœ¬ï¼ˆå·²å®Œæˆå¯åˆ é™¤ï¼‰
- æ ‡è®°å“ªäº›æ˜¯å¸¸ç”¨ç»´æŠ¤å·¥å…·

## âœ¨ æ•´ç†æ•ˆæœ

### æ•´ç†å‰çš„é—®é¢˜
- âŒ æ ¹ç›®å½•æ±¡æŸ“ä¸¥é‡ï¼Œæ–‡ä»¶æ··æ‚
- âŒ é…ç½®å¤‡ä»½æš´éœ²åœ¨æ ¹ç›®å½•
- âŒ è¿ç§»è„šæœ¬ã€ç»´æŠ¤è„šæœ¬ã€CIè„šæœ¬æ··åœ¨ä¸€èµ·
- âŒ éš¾ä»¥å¿«é€Ÿå®šä½éœ€è¦çš„è„šæœ¬
- âŒ ä¸ç¬¦åˆ NestJS é¡¹ç›®è§„èŒƒ

### æ•´ç†åçš„ä¼˜åŠ¿
- âœ… æ ¹ç›®å½•æ¸…çˆ½ï¼Œåªä¿ç•™æ ¸å¿ƒé…ç½®
- âœ… è„šæœ¬æŒ‰åŠŸèƒ½åˆ†ç±»ï¼Œç»“æ„æ¸…æ™°
- âœ… æ•æ„Ÿæ•°æ®å— .gitignore ä¿æŠ¤
- âœ… ç¬¦åˆ Node.js/NestJS é¡¹ç›®æœ€ä½³å®è·µ
- âœ… æ˜“äºç»´æŠ¤å’Œåä½œ

## ğŸ‰ æ•´ç†å®Œæˆ

æ ¹ç›®å½•å·²ç»å˜å¾—æ¸…çˆ½æ•´æ´ï¼Œä»åŸæ¥çš„20+ä¸ªæ‚é¡¹æ–‡ä»¶å‡å°‘åˆ°åªä¿ç•™æ ¸å¿ƒé…ç½®å’Œç›®å½•ã€‚æ‰€æœ‰è„šæœ¬éƒ½å·²æŒ‰åŠŸèƒ½åˆ†ç±»æ•´ç†åˆ° `scripts/` ç›®å½•ä¸‹ï¼Œé¡¹ç›®ç»“æ„æ›´åŠ è§„èŒƒå’Œæ˜“äºç»´æŠ¤ã€‚

---

**æ•´ç†å®Œæˆæ—¶é—´**: 2026-01-05  
**æ•´ç†äºº**: AI Assistant  
**è„šæœ¬æ€»æ•°**: 17ä¸ªè„šæœ¬å·²å½’æ¡£åˆ° `scripts/` ç›®å½•









